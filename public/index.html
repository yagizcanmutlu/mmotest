<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AGORA – Sosyal Hub</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:#000;font-family:Inter,system-ui,Arial}
    #root{height:100dvh;width:100vw;overflow:hidden;position:relative}

    .hud{position:absolute;top:12px;left:12px;display:flex;gap:10px;align-items:center;z-index:10}
    .logo{color:#8ef;font-weight:800;letter-spacing:.3px;text-shadow:0 0 8px #48f}
    .points{padding:6px 10px;border:1px solid #2a5;border-radius:8px;color:#aef;background:rgba(10,30,18,.35);backdrop-filter:blur(4px)}
    .help-btn{margin-left:8px; width:32px;height:32px;border-radius:8px;border:1px solid #234;background:rgba(8,10,20,.6);color:#9cf;cursor:pointer;font-weight:800}

    .help{position:absolute;top:56px;left:12px;z-index:12;display:none;
      background:rgba(8,10,20,.92);border:1px solid #234;border-radius:12px;color:#cfe;padding:12px;max-width:320px}
    .help h3{margin:0 0 6px 0;color:#9cf}
    .help ul{padding-left:18px}
    .help small{opacity:.8}

    .cta{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:12;background:rgba(0,0,0,.55);backdrop-filter:blur(4px)}
    .card{padding:18px 16px;background:rgba(8,10,20,.9);border:1px solid #234;border-radius:14px;width:320px;display:flex;flex-direction:column;gap:10px}
    .card h1{color:#9cf;font-size:18px}
    .card input{padding:10px;border-radius:10px;border:1px solid #345;background:#0a0f14;color:#cfe}
    .card button{padding:12px;border-radius:12px;border:0;font-weight:700;background:#1d8f4a;color:#eafff0;cursor:pointer}

    /* Chat sağ altta */
    .chat{position:absolute;right:12px;bottom:12px;width:340px;z-index:10}
    .chat-log{height:150px;overflow:auto;background:rgba(5,7,12,.55);border:1px solid #223;border-radius:10px;padding:8px;color:#cfe}
    .chat-log p{margin:4px 0}
    .chat-input{margin-top:6px;display:flex;gap:6px}
    .chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid #345;background:#0a0f14;color:#cfe}
    .chat-input button{padding:10px 12px;border-radius:10px;border:0;background:#29549b;color:#e7f0ff;cursor:pointer}

    .floating{position:absolute;top:60px;left:50%;transform:translateX(-50%);color:#aff;text-shadow:0 0 8px #0ff;z-index:10;font-weight:700;display:none}

    /* Mobile controls */
    #joystick{position:absolute;left:14px;bottom:14px;width:120px;height:120px;border-radius:50%;border:1px solid #234;background:rgba(10,14,20,.35);backdrop-filter:blur(3px);z-index:11;touch-action:none}
    #stick{position:absolute;left:50%;top:50%;width:56px;height:56px;transform:translate(-50%,-50%);border-radius:50%;background:rgba(80,180,255,.35);border:1px solid #2a4}
    #lookpad{position:absolute;right:0;bottom:0;width:40vw;height:55vh;z-index:11;touch-action:none}

    @media (max-width: 900px){
      .chat{width:260px}
      .chat-log{height:120px}
    }
  </style>

  <!-- THREE r152 -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="root">
    <div class="hud">
      <div class="logo">AGORA</div>
      <div class="points" id="points">Points: 0</div>
      <button class="help-btn" id="helpBtn">?</button>
    </div>

    <div class="help" id="helpBox">
      <h3>Kontroller</h3>
      <ul>
        <li><b>WASD</b>: İleri/geri & sol/sağ</li>
        <li><b>Fare</b> veya sağ alanı <b>sürükle</b>: Bakış</li>
        <li><b>Tekerlek</b>: Zoom</li>
        <li><b>1–6</b> veya <code>/wave /dance /sit /clap /point /cheer</code></li>
        <li><b>Enter</b>: Chat’e odaklan/aç</li>
      </ul>
      <small>Mobilde: Sol joystick hareket, sağ alan sürükle bakış.</small>
    </div>

    <div class="cta" id="cta">
      <div class="card">
        <h1>Agora'ya katıl</h1>
        <input id="nameInput" placeholder="Görünen adın (ör. Yağız)" maxlength="20" />
        <button id="playBtn">Giriş (WASD + Fare • Mobil: Joystick)</button>
      </div>
    </div>

    <div class="chat">
      <div class="chat-log" id="chatLog"></div>
      <div class="chat-input">
        <input id="chatText" placeholder="Mesaj yaz… (/wave, /dance …)" />
        <button id="chatSend">Gönder</button>
      </div>
    </div>

    <!-- Mobile controls -->
    <div id="joystick"><div id="stick"></div></div>
    <div id="lookpad"></div>

    <div class="floating" id="toast"></div>
  </div>

  <!-- Oyun istemcisi (varsa sahneyi buradan kuruyorsun) -->
  <script src="client.js"></script>

  <!-- Yardım toggle -->
  <script>
    const helpBtn = document.getElementById("helpBtn");
    const helpBox = document.getElementById("helpBox");
    helpBtn.addEventListener("click", ()=> {
      helpBox.style.display = helpBox.style.display === "block" ? "none" : "block";
    });
  </script>

  <!-- Prosedürel Uzay Üssü Zemin – AGORA Entegrasyonu + Test Fallback -->
  <script>
  // === Parametreler ===
  const FLOOR_PARAMS = {
    size: 280,
    tilesPerUnit: 2.7,
    grooveWidth: 0.032,
    bevel: 0.016,
    emissiveStrength: 1.55,
    stripeDensity: 7.0,
    metalA: "#77808a",
    metalB: "#262b31",
    caution: "#ffcf5a",
    ambient: 0.24,
    lightColor: "#99c9ff",
    lightDir: new THREE.Vector3(0.4, 1.0, 0.25).normalize(),
    scrollSpeed: 0.28
  };
  const WAIT_AGORA_MS = 2000;     // AGORA sahnesini bekleme süresi
  const FALLBACK_ENABLE = true;   // AGORA yoksa test modu aç

  // === Zemin Shader'ı ===
  function createSpaceBaseFloor(THREE, opts = {}) {
    const params = Object.assign({}, FLOOR_PARAMS, opts);
    const toLinear = (hex)=>new THREE.Color(hex);
    const uniforms = {
      uTime:{value:0}, uTiles:{value:params.tilesPerUnit}, uGrooveW:{value:params.grooveWidth},
      uBevel:{value:params.bevel}, uEmissiveK:{value:params.emissiveStrength}, uStripeDensity:{value:params.stripeDensity},
      uAmbient:{value:params.ambient}, uLightColor:{value:toLinear(params.lightColor)},
      uLightDir:{value:params.lightDir.clone()}, uMetalA:{value:toLinear(params.metalA)},
      uMetalB:{value:toLinear(params.metalB)}, uCaution:{value:toLinear(params.caution)},
      uScroll:{value:params.scrollSpeed}, uCamPos:{value:new THREE.Vector3()}
    };
    const vert=`varying vec3 vWorldPos;void main(){vec4 wp=modelMatrix*vec4(position,1.0);vWorldPos=wp.xyz;gl_Position=projectionMatrix*viewMatrix*wp;}`;
    const frag=`
    precision highp float;
    varying vec3 vWorldPos;
    uniform float uTime,uTiles,uGrooveW,uBevel,uEmissiveK,uStripeDensity,uAmbient,uScroll;
    uniform vec3 uLightColor,uLightDir,uMetalA,uMetalB,uCaution,uCamPos;
    float hash21(vec2 p){p=fract(p*vec2(123.34,456.21));p+=dot(p,p+45.32);return fract(p.x*p.y);}
    vec2 hash22(vec2 p){float n=sin(dot(p,vec2(41.232,289.13)))*43758.5453;return fract(vec2(n,n*1.2154));}
    vec2 tileUV(vec3 wp){return wp.xz*uTiles;}
    float panelHeight(vec2 p){
      vec2 cell=floor(p); vec2 gv=fract(p)-0.5; vec2 dv=(0.5-abs(gv)); float edge=min(dv.x,dv.y);
      float groove=1.0 - smoothstep(uGrooveW-uBevel, uGrooveW+uBevel, edge);
      float h=-groove*0.06;
      vec2 r=hash22(cell);
      if(r.x>0.62){
        float band=smoothstep(0.19,0.18,abs(gv.x-(r.y-0.5)*0.15));
        float lines=7.0+floor(r.y*4.0);
        float t=(gv.y+0.35)*lines;
        float saw=abs(fract(t)-0.5);
        float slots=smoothstep(0.03,0.02,saw)*band;
        h-=slots*0.04;
      }
      return h;
    }
    vec3 heightNormal(vec2 p){
      float e=0.003;
      float h=panelHeight(p);
      float hx=panelHeight(p+vec2(e,0.0));
      float hy=panelHeight(p+vec2(0.0,e));
      return normalize(vec3(-(hx-h)/e,1.0,-(hy-h)/e));
    }
    float cautionMask(vec2 p, out float stripes){
      vec2 cell=floor(p); vec2 gv=fract(p)-0.5; float rnd=hash21(cell); stripes=0.0;
      if(rnd>0.65){
        float edgeBand=smoothstep(0.12,0.10,min(0.5-abs(gv.x),0.5-abs(gv.y)));
        float dir=(rnd>0.82)?1.0:-1.0;
        float ramp=(abs(gv.x)>abs(gv.y))?gv.y:gv.x;
        float dens=uStripeDensity+floor(rnd*3.0);
        float s=fract(ramp*dens+uTime*uScroll*dir);
        float bar=step(0.5,s);
        stripes=bar*edgeBand;
        return smoothstep(0.0,0.02,edgeBand);
      }
      return 0.0;
    }
    float grunge(vec2 p){float n=0.0;n+=hash21(p*0.5)*0.5;n+=hash21(p*2.7)*0.35;n+=hash21(p*7.7)*0.15;return n;}
    void main(){
      vec2 p=tileUV(vWorldPos);
      vec2 cell=floor(p);
      float cellMix=hash21(cell);
      vec3 baseCol=mix(uMetalB,uMetalA,cellMix*0.85+0.1);
      vec3 n=heightNormal(p);
      vec3 L=normalize(uLightDir);
      float ndl=max(dot(n,L),0.0);
      vec3 V=normalize(uCamPos - vWorldPos);
      vec3 H=normalize(L+V);
      float spec=pow(max(dot(n,H),0.0),32.0)*0.25;
      float stripes;
      float cMask=cautionMask(p,stripes);
      vec3 cautionPaint=mix(baseCol,uCaution,cMask*0.85);
      float pulse=0.6+0.4*sin(uTime*3.0+cellMix*6.2831);
      vec3 emissive=uCaution*(stripes*uEmissiveK*pulse);
      float edge=(1.0 - smoothstep(uGrooveW-0.005, uGrooveW+0.005, min(0.5-abs(fract(p).x-0.5), 0.5-abs(fract(p).y-0.5))));
      float ao=1.0 - edge*0.22;
      float dirt=grunge(p*0.75);
      vec3 albedo=mix(baseCol,cautionPaint,cMask);
      albedo*=mix(0.95,1.05,dirt*0.2);
      vec3 lit=albedo*(uAmbient+ndl)*uLightColor*ao + spec + emissive;
      gl_FragColor=vec4(lit,1.0);
    }`;
    const mat = new THREE.ShaderMaterial({vertexShader:vert, fragmentShader:frag, uniforms, dithering:true});
    mat.toneMapped = true;
    mat.side = THREE.DoubleSide; // kameran zeminin altına girse de görünür kalsın
    const geo = new THREE.PlaneGeometry(params.size, params.size, 1, 1);
    const mesh = new THREE.Mesh(geo, mat);
    mesh.rotation.x = -Math.PI*0.5;
    mesh.position.y = 0;
    mesh.receiveShadow = true;
    return { mesh, material: mat, uniforms };
  }

  // === AGORA sahnesine ekle (varsa) ===
  (function attachOrFallback(){
    const start = performance.now();
    const root = document.getElementById('root');

    function tryAttach(){
      const A = window.AGORA;
      if (A && A.scene && A.camera) {
        const floor = createSpaceBaseFloor(THREE);
        // Her render'da zamanı ve kamera konumunu güncelle
        floor.mesh.onBeforeRender = function(renderer, scene, camera){
          floor.uniforms.uTime.value = performance.now()/1000;
          floor.uniforms.uCamPos.value.copy(camera.position);
        };
        A.scene.add(floor.mesh);
        console.log('%c[AGORA] SpaceBaseFloor eklendi.','color:#9cf');
        return true;
      }
      return false;
    }

    function bootFallback(){
      if (!FALLBACK_ENABLE) return;
      console.warn('[AGORA] AGORA.scene bulunamadı; test modu başlıyor.');
      const renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(devicePixelRatio);
      renderer.domElement.style.position='absolute';
      renderer.domElement.style.inset='0';
      renderer.domElement.style.zIndex='0'; // HUD üstte kalsın
      root.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0d12);

      const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
      camera.position.set(0, 6, 10);
      camera.lookAt(0,0,0);

      // Işıklar
      scene.add(new THREE.HemisphereLight(0x88aaff, 0x222233, 0.35));
      const dir = new THREE.DirectionalLight(0xffffff, 0.85);
      dir.position.set(3,6,2); scene.add(dir);

      // Zemin + test kutusu
      const floor = createSpaceBaseFloor(THREE);
      scene.add(floor.mesh);
      const box = new THREE.Mesh(
        new THREE.BoxGeometry(1,1,1),
        new THREE.MeshStandardMaterial({color:0x66ccff, metalness:0.4, roughness:0.5})
      );
      box.position.y=0.5; scene.add(box);

      // Resize
      addEventListener('resize', ()=>{
        camera.aspect = innerWidth/innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
      });

      // Loop
      function animate(){
        requestAnimationFrame(animate);
        floor.uniforms.uTime.value = performance.now()/1000;
        floor.uniforms.uCamPos.value.copy(camera.position);
        box.rotation.y += 0.01;
        renderer.render(scene, camera);
      }
      animate();
    }

    // 2 sn AGORA bekle, sonra fallback
    function wait(){
      if (tryAttach()) return;
      if (performance.now() - start > WAIT_AGORA_MS) { bootFallback(); return; }
      requestAnimationFrame(wait);
    }
    wait();
  })();
  </script>
</body>
</html>
