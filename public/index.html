<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AGORA â€“ Sosyal Hub</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:#000;font-family:Inter,system-ui,Arial}
    #root{height:100dvh;width:100vw;overflow:hidden;position:relative}

    .hud{position:absolute;top:12px;left:12px;display:flex;gap:10px;align-items:center;z-index:10}
    .logo{color:#8ef;font-weight:800;letter-spacing:.3px;text-shadow:0 0 8px #48f}
    .points{padding:6px 10px;border:1px solid #2a5;border-radius:8px;color:#aef;background:rgba(10,30,18,.35);backdrop-filter:blur(4px)}
    .help-btn{margin-left:8px;width:32px;height:32px;border-radius:8px;border:1px solid #234;background:rgba(8,10,20,.6);color:#9cf;cursor:pointer;font-weight:800}

    .help{position:absolute;top:56px;left:12px;z-index:12;display:none;background:rgba(8,10,20,.92);border:1px solid #234;border-radius:12px;color:#cfe;padding:12px;max-width:320px}
    .help h3{margin:0 0 6px 0;color:#9cf}
    .help ul{padding-left:18px}
    .help small{opacity:.8}

    .cta{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:12;background:rgba(0,0,0,.55);backdrop-filter:blur(4px)}
    .card{padding:18px 16px;background:rgba(8,10,20,.9);border:1px solid #234;border-radius:14px;width:320px;display:flex;flex-direction:column;gap:10px}
    .card h1{color:#9cf;font-size:18px}
    .card input{padding:10px;border-radius:10px;border:1px solid #345;background:#0a0f14;color:#cfe}
    .card button{padding:12px;border-radius:12px;border:0;font-weight:700;background:#1d8f4a;color:#eafff0;cursor:pointer}

    .chat{position:absolute;right:12px;bottom:12px;width:340px;z-index:10}
    .chat-log{height:150px;overflow:auto;background:rgba(5,7,12,.55);border:1px solid #223;border-radius:10px;padding:8px;color:#cfe}
    .chat-log p{margin:4px 0}
    .chat-input{margin-top:6px;display:flex;gap:6px}
    .chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid #345;background:#0a0f14;color:#cfe}
    .chat-input button{padding:10px 12px;border-radius:10px;border:0;background:#29549b;color:#e7f0ff;cursor:pointer}

    .floating{position:absolute;top:60px;left:50%;transform:translateX(-50%);color:#aff;text-shadow:0 0 8px #0ff;z-index:10;font-weight:700;display:none}

    #joystick{position:absolute;left:14px;bottom:14px;width:120px;height:120px;border-radius:50%;border:1px solid #234;background:rgba(10,14,20,.35);backdrop-filter:blur(3px);z-index:11;touch-action:none}
    #stick{position:absolute;left:50%;top:50%;width:56px;height:56px;transform:translate(-50%,-50%);border-radius:50%;background:rgba(80,180,255,.35);border:1px solid #2a4}
    #lookpad{position:absolute;right:0;bottom:0;width:40vw;height:55vh;z-index:11;touch-action:none}

    /* NFT modal */
    .nft-modal{position:fixed;inset:0;z-index:9998;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
    .nft-card{width:min(920px,92vw);max-height:86vh;overflow:auto;background:rgba(8,10,20,.96);border:1px solid #234;border-radius:16px;padding:14px;color:#d9ecff}
    .nft-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:10px}
    .nft-tile{border:1px solid #334;border-radius:12px;padding:8px;background:#0b0f18;cursor:pointer;display:flex;flex-direction:column;gap:6px}
    .nft-tile img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
    .nft-tile h4{font:700 13px/1.2 Inter,system-ui}
    .nft-tile p{font:600 12px/1.2 Inter,system-ui;color:#9ad1ff}
    .nft-tile.selected{outline:2px solid #1d8f4a;box-shadow:0 0 0 2px #1d8f4a inset}
    .nft-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #2a4;background:#0a151a;color:#d9ecff;cursor:pointer}
    .btn.-primary{background:#1d8f4a;border-color:#2e9d5d;color:#ecfff2;font-weight:800}
    .nft-mini{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.35);padding:8px;border-radius:10px}
    .nft-mini img{width:40px;height:40px;border-radius:8px;object-fit:cover}
  </style>

  <style>
    /* Genel */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      height:100%;
      background:#000;
      font-family:Inter,system-ui,Arial;
      overscroll-behavior:none;
      overflow:hidden;            /* yarÄ±m ekran zÄ±plamasÄ±nÄ± Ã¶nler */
    }

    /* Sahneyi ekrana kilitle */
    #root{
      position:fixed; inset:0;
      width:100vw; height:100vh; overflow:hidden;
    }
    @supports(height:100dvh){ #root{ height:100dvh } }

    /* HUD */
    .hud{position:absolute;top:12px;left:12px;display:flex;gap:10px;align-items:center;z-index:10}
    .logo{color:#8ef;font-weight:800;letter-spacing:.3px;text-shadow:0 0 8px #48f}
    .points{padding:6px 10px;border:1px solid #2a5;border-radius:8px;color:#aef;background:rgba(10,30,18,.35);backdrop-filter:blur(4px)}
    .help-btn{margin-left:8px;width:32px;height:32px;border-radius:8px;border:1px solid #234;background:rgba(8,10,20,.6);color:#9cf;cursor:pointer;font-weight:800}

    .help{position:absolute;top:56px;left:12px;z-index:12;display:none;background:rgba(8,10,20,.92);border:1px solid #234;border-radius:12px;color:#cfe;padding:12px;max-width:320px}
    .help h3{margin:0 0 6px 0;color:#9cf}
    .help ul{padding-left:18px}
    .help small{opacity:.8}

    /* GiriÅŸ kartÄ± */
    .cta{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:12;background:rgba(0,0,0,.55);backdrop-filter:blur(4px)}
    .card{padding:18px 16px;background:rgba(8,10,20,.9);border:1px solid #234;border-radius:14px;width:320px;display:flex;flex-direction:column;gap:10px}
    .card h1{color:#9cf;font-size:18px}
    .card input{padding:10px;border-radius:10px;border:1px solid #345;background:#0a0f14;color:#cfe}
    .card button{padding:12px;border-radius:12px;border:0;font-weight:700;background:#1d8f4a;color:#eafff0;cursor:pointer}

    /* === CHAT: SaÄŸ-alta sabit, varsayÄ±lan aÃ§Ä±k === */
    .chat{
      position:fixed;
      right:clamp(8px,2vw,16px);
      bottom:calc(12px + env(safe-area-inset-bottom));
      width:min(360px,90vw);
      z-index:30;
    }
    .chat.-hidden{ display:none; }            /* kapalÄ± durum */
    .chat-log{
      height:150px;overflow:auto;background:rgba(5,7,12,.55);
      border:1px solid #223;border-radius:10px;padding:8px;color:#cfe
    }
    .chat-log p{margin:4px 0}
    .chat-input{margin-top:6px;display:flex;gap:6px}
    .chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid #345;background:#0a0f14;color:#cfe}
    .chat-input button{padding:10px 12px;border-radius:10px;border:0;background:#29549b;color:#e7f0ff;cursor:pointer}

    /* Panel iÃ§i kapat butonu (X) */
    .chat-close{
      position:absolute;top:-48px;right:0;width:40px;height:40px;
      border:1px solid #234;border-radius:10px;background:rgba(8,10,20,.7);
      color:#9cf;font-weight:800;cursor:pointer
    }

    /* YalnÄ±zca kapalÄ±yken gÃ¶rÃ¼nen kÃ¼Ã§Ã¼k balon */
    .chat-toggle{
      position:fixed;right:clamp(8px,2vw,16px);
      bottom:calc(12px + env(safe-area-inset-bottom));
      width:44px;height:44px;border-radius:12px;border:1px solid #234;
      background:rgba(8,10,20,.7);color:#9cf;z-index:31;cursor:pointer;
      display:none;align-items:center;justify-content:center;font-size:18px
    }
    .chat-toggle.-show{ display:flex; }

    /* DiÄŸer overlayler */
    .floating{position:absolute;top:60px;left:50%;transform:translateX(-50%);color:#aff;text-shadow:0 0 8px #0ff;z-index:10;font-weight:700;display:none}

    #joystick{position:absolute;left:14px;bottom:14px;width:120px;height:120px;border-radius:50%;border:1px solid #234;background:rgba(10,14,20,.35);backdrop-filter:blur(3px);z-index:11;touch-action:none}
    #stick{position:absolute;left:50%;top:50%;width:56px;height:56px;transform:translate(-50%,-50%);border-radius:50%;background:rgba(80,180,255,.35);border:1px solid #2a4}
    #lookpad{position:absolute;right:0;bottom:0;width:40vw;height:55vh;z-index:11;touch-action:none}

    /* NFT modal */
    .nft-modal{position:fixed;inset:0;z-index:9998;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
    .nft-card{width:min(920px,92vw);max-height:86vh;overflow:auto;background:rgba(8,10,20,.96);border:1px solid #234;border-radius:16px;padding:14px;color:#d9ecff}
    .nft-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:10px}
    .nft-tile{border:1px solid #334;border-radius:12px;padding:8px;background:#0b0f18;cursor:pointer;display:flex;flex-direction:column;gap:6px}
    .nft-tile img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}
    .nft-tile h4{font:700 13px/1.2 Inter,system-ui}
    .nft-tile p{font:600 12px/1.2 Inter,system-ui;color:#9ad1ff}
    .nft-tile.selected{outline:2px solid #1d8f4a;box-shadow:0 0 0 2px #1d8f4a inset}
    .nft-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #2a4;background:#0a151a;color:#d9ecff;cursor:pointer}
    .btn.-primary{background:#1d8f4a;border-color:#2e9d5d;color:#ecfff2;font-weight:800}
    .nft-mini{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.35);padding:8px;border-radius:10px}
    .nft-mini img{width:40px;height:40px;border-radius:8px;object-fit:cover}

    /* Mobilde geniÅŸliÄŸi biraz daralt; lookpadâ€™e gÃ¶re JS ayrÄ±ca sÄ±ÄŸdÄ±racak */
    @media (pointer:coarse){
      .chat{ width:min(320px,80vw) }
    }
  </style>



</head>

<!-- three import map (client.js'ten Ã¶nce yÃ¼klenmeli) -->
<script type="importmap">
{ "imports": {
  "three": "/vendor/three/build/three.module.js",
  "three/examples/jsm/": "/vendor/three/examples/jsm/"
} }
</script>

<body>
  <div id="root">
    <div class="hud">
      <div class="logo">AGORA</div>
      <div class="points" id="points">Points: 0</div>
      <button class="help-btn" id="helpBtn">?</button>
    </div>

    <div class="help" id="helpBox">
      <h3>Kontroller</h3>
      <ul>
        <li><b>WASD</b>: Ä°leri/geri & sol/saÄŸ</li>
        <li><b>Fare</b> veya saÄŸ alanÄ± <b>sÃ¼rÃ¼kle</b>: BakÄ±ÅŸ</li>
        <li><b>Tekerlek</b>: Zoom</li>
        <li><b>1â€“6</b> veya <code>/wave /dance /sit /clap /point /cheer</code></li>
        <li><b>Enter</b>: Chatâ€™e odaklan/aÃ§</li>
      </ul>
      <small>Mobilde: Sol joystick hareket, saÄŸ alan sÃ¼rÃ¼kle bakÄ±ÅŸ.</small>
    </div>

    <!-- CTA / Join -->
    <div class="cta" id="cta">
      <div class="card">
        <h1>Agora'ya katÄ±l</h1>

        <!-- SeÃ§ilen NFT Ã¶zetini gÃ¶sterir -->
        <div id="chosenNftMini" class="nft-mini" style="display:none">
          <img id="chosenNftImg" src="" alt="">
          <div>
            <div id="chosenNftName" style="font-weight:800"></div>
            <small id="chosenNftStats" style="opacity:.8"></small>
          </div>
        </div>

        <input id="nameInput" placeholder="GÃ¶rÃ¼nen adÄ±n (Ã¶r. Yogi)" maxlength="20" />

        <button id="playBtn" type="button">GiriÅŸ</button>
        <button id="openNftSelect" class="btn" type="button">NFT SeÃ§</button>
      </div>
    </div>

    <!-- Chat -->
    <div id="chatPanel" class="chat">
      <button id="chatClose" class="chat-close" title="Kapat">Ã—</button>
      <div class="chat-log" id="chatLog"></div>
      <div class="chat-input">
        <input id="chatText" placeholder="Mesaj yazâ€¦ (/wave, /dance â€¦)" />
        <button id="chatSend">GÃ¶nder</button>
      </div>
    </div>

    <!-- KapalÄ±yken gÃ¶rÃ¼nen minik balon -->
    <button id="chatToggle" class="chat-toggle" aria-label="Sohbeti aÃ§">ðŸ’¬</button>


    <div id="joystick"><div id="stick"></div></div>
    <div id="lookpad"></div>

    <div class="floating" id="toast"></div>
  </div>

  <!-- NFT SeÃ§im ModalÄ± -->
  <div id="nftModal" class="nft-modal" aria-hidden="true">
    <div class="nft-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h3 style="margin:0;color:#9cf">NFT KARAKTERÄ°NÄ° SEÃ‡</h3>
        <div id="walletLabel" style="opacity:.8;font:600 12px/1.2 Inter"></div>
      </div>
      <div id="nftGrid" class="nft-grid"><div style="opacity:.7">NFT'ler yÃ¼kleniyorâ€¦</div></div>
      <div class="nft-actions">
        <button id="closeNft" class="btn">Ä°ptal</button>
        <button id="useNft" class="btn -primary" disabled>Bu NFT ile GÄ°R</button>
      </div>
    </div>
  </div>

<script>
  // YardÄ±m toggle
  const helpBtn = document.getElementById("helpBtn");
  const helpBox = document.getElementById("helpBox");
  helpBtn.addEventListener("click", ()=> {
    helpBox.style.display = helpBox.style.display === "block" ? "none" : "block";
  });

  // ðŸ—¨ï¸ Chat AÃ§/Kapa â€” layoutâ€™u hiÃ§ etkilemeden sadece gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸtirir
  const chatEl      = document.querySelector('.chat');
  const chatToggle  = document.getElementById('chatToggle');
  const isMobileUA  = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  function setChatOpen(open){
    if(open){ chatEl.classList.remove('-collapsed'); chatToggle.setAttribute('aria-pressed','true'); }
    else    { chatEl.classList.add('-collapsed');    chatToggle.setAttribute('aria-pressed','false'); }
  }

  // VarsayÄ±lan: mobilde aÃ§Ä±k, desktopâ€™ta kapalÄ±
  setChatOpen(isMobileUA ? true : false);

  chatToggle.addEventListener('click', () => {
    const open = chatEl.classList.contains('-collapsed');
    setChatOpen(open);
  });

  // Mobil klavye aÃ§Ä±ldÄ±ÄŸÄ±nda viewport zÄ±plamasÄ±nÄ± azalt
  // (Sahne fixed olmasÄ±na raÄŸmen gÃ¼vence iÃ§in)
  window.addEventListener('focusin', (e) => {
    if(e.target && e.target.id === 'chatText'){
      window.scrollTo(0,0);
    }
  });
</script>


  <!-- === GÃ¼venli NFT akÄ±ÅŸÄ± (BACKEND Ã¼stÃ¼nden) â€” client.js'ten Ã–NCE === -->
  <script>
    // const BACKEND_BASE = "https://mmotest-5uut.onrender.com";
    const BACKEND_BASE = ""; // aynÄ± origin

    const allowedOrigins = [
      'https://cryptoyogi.webflow.io',
      'https://www.cryptoyogi.com',
      'https://www.cryptoyogi.world',
      'https://yagizcanmutlu.github.io'
    ];

    // State
    let walletFromHost = null;
    let allWalletNFTs = [];
    let selectedNFT = null;

    // UI refs
    const nftModal   = document.getElementById('nftModal');
    const nftGrid    = document.getElementById('nftGrid');
    const walletLbl  = document.getElementById('walletLabel');
    const useNftBtn  = document.getElementById('useNft');
    const closeNftBtn= document.getElementById('closeNft');
    const openNftBtn = document.getElementById('openNftSelect');

    const nameInput  = document.getElementById('nameInput');

    const chosenMini = document.getElementById('chosenNftMini');
    const chosenImg  = document.getElementById('chosenNftImg');
    const chosenName = document.getElementById('chosenNftName');
    const chosenStats= document.getElementById('chosenNftStats');

    const mask = (addr)=> addr ? (addr.slice(0,4)+'â€¦'+addr.slice(-4)) : '';

    // Backend'ten NFT Ã§ek
    async function fetchWalletNFTs(wallet){
      const clean = (wallet||'').trim().toLowerCase();
      if(!clean) return [];
      const url = `${BACKEND_BASE}/api/nfts?wallet=${encodeURIComponent(clean)}`;
      const res = await fetch(url, { credentials: 'include' });
      if(!res.ok){ console.error('NFT fetch hata', res.status); return []; }
      const data = await res.json();

      if (Array.isArray(data.nfts)) return data.nfts;

      if (Array.isArray(data.records)) {
        return data.records.map(r => {
          const f = r.fields || {};
          const img = Array.isArray(f.image) && f.image.length ? (f.image[0].url || f.image[0]) : (f.image_url || f.image);
          return {
            id: r.id,
            name: f.nft_name_list || f.name || 'Unnamed NFT',
            imageUrl: img || 'https://placehold.co/300x300/111/AAA?text=NFT',
            atk: f.ap ?? f.atk ?? 50,
            def: f.dp ?? f.def ?? 30,
            level: f.level ?? 1,
            crit: f.crit_chance ?? 0.2
          };
        });
      }
      return [];
    }

    // Modal helpers
    function openModal(){ nftModal.style.display='flex'; nftModal.setAttribute('aria-hidden','false'); }
    function closeModal(){ nftModal.style.display='none'; nftModal.setAttribute('aria-hidden','true'); }

    function renderNFTGrid(nfts){
      nftGrid.innerHTML = '';
      nfts.forEach(nft => {
        const tile = document.createElement('div');
        tile.className = 'nft-tile';
        tile.innerHTML = `
          <img src="${nft.imageUrl}" alt="">
          <h4>${nft.name}</h4>
          <p>LVL ${nft.level} â€¢ ATK ${nft.atk} â€¢ DEF ${nft.def}</p>`;
        tile.addEventListener('click', () => {
          [...nftGrid.children].forEach(x=>x.classList.remove('selected'));
          tile.classList.add('selected');
          selectedNFT = nft;
          useNftBtn.disabled = false;
        });
        nftGrid.appendChild(tile);
      });
      if(nfts.length===0){
        nftGrid.innerHTML = '<div style="opacity:.7">Bu cÃ¼zdanda kayÄ±tlÄ± NFT bulunamadÄ±.</div>';
      }
    }

    function applyChosenNFT(){
      if(!selectedNFT) return;
      nameInput.value = selectedNFT.name || nameInput.value;
      chosenMini.style.display = 'flex';
      chosenImg.src   = selectedNFT.imageUrl || '';
      chosenName.textContent = selectedNFT.name || 'NFT';
      chosenStats.textContent = `LVL ${selectedNFT.level ?? 1} â€¢ ATK ${selectedNFT.atk ?? 0} â€¢ DEF ${selectedNFT.def ?? 0}`;
    }

    // GiriÅŸ â†’ client.js'e payload ver
    document.getElementById('playBtn').addEventListener('click', () => {
      const payload = {
        wallet: walletFromHost,
        nft: selectedNFT || null,
        playerName: nameInput.value.trim() || (selectedNFT ? selectedNFT.name : 'Player')
      };
      window.agoraInjectedPayload = payload;
      window.dispatchEvent(new CustomEvent('agoraInit', { detail: payload }));
    });

    // Modal kontrolleri
    openNftBtn.addEventListener('click', () => {
      if(!walletFromHost){ alert('CÃ¼zdan adresi henÃ¼z gelmedi.'); return; }
      walletLbl.textContent = 'CÃ¼zdan: ' + mask(walletFromHost);
      renderNFTGrid(allWalletNFTs);
      openModal();
    });
    closeNftBtn.addEventListener('click', closeModal);
    useNftBtn.addEventListener('click', () => { applyChosenNFT(); closeModal(); });

    // Host â†’ cÃ¼zdan (Webflow embed)
    window.addEventListener('message', async (event) => {
      if(!allowedOrigins.includes(event.origin)) return;
      const msg = event.data || {};
      if(msg.type === 'walletAddress'){
        walletFromHost = (msg.address||'').trim();
        walletLbl.textContent = 'CÃ¼zdan: ' + mask(walletFromHost);
        allWalletNFTs = await fetchWalletNFTs(walletFromHost);
        if(allWalletNFTs.length === 1){
          selectedNFT = allWalletNFTs[0];
          applyChosenNFT();
        } else {
          renderNFTGrid(allWalletNFTs);
          openModal();
        }
      }
      if(msg.type === 'selectedNFT' && msg.payload){
        selectedNFT = msg.payload;
        applyChosenNFT();
      }
    });

    // Fallback: URL ?wallet= adresinden al (yerel test iÃ§in)
    (async () => {
      const u = new URL(location.href);
      const w = u.searchParams.get('wallet');
      if (w && !walletFromHost) {
        walletFromHost = w.trim();
        walletLbl.textContent = 'CÃ¼zdan: ' + mask(walletFromHost);
        allWalletNFTs = await fetchWalletNFTs(walletFromHost);
        if(allWalletNFTs.length === 1){
          selectedNFT = allWalletNFTs[0];
          applyChosenNFT();
        }
      }
    })();
  </script>

  <!-- SÄ±ra Ã¶nemli: Ã¶nce socket.io, sonra socket baÅŸlat, en sonda client.js -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io("/", {
      transports: ["websocket", "polling"],
      upgrade: true,
      timeout: 20000,
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 800,
      withCredentials: true
    });

    socket.on("connect_error", (err) => {
      // WebSocket upgrade hatalarÄ±nÄ± sessize al
      if (String(err?.message || "").toLowerCase().includes("websocket")) return;
      console.warn("socket connect_error", err);
    });
    // window.socket = socket; // gerekirse globalleÅŸtir
  </script>

  <script type="module" src="/client.js"></script>

  <script>
  (() => {
    const panel  = document.getElementById('chatPanel');
    const toggle = document.getElementById('chatToggle');
    const closeB = document.getElementById('chatClose');
    const input  = document.getElementById('chatText');

    if(!panel || !toggle || !closeB){ console.warn('[CHAT] eksik eleman'); return; }

    function openChat(){
      panel.classList.remove('-hidden');
      toggle.classList.remove('-show');          // kare kutucuk sadece kapalÄ±yken
      setTimeout(() => input?.focus(), 0);
      try{ document.exitPointerLock?.() }catch{}
      fitNextToLookpad();                         // konumu/geneiÌ§sÌ§liÄŸi gÃ¼ncelle
    }
    function closeChat(){
      panel.classList.add('-hidden');
      toggle.classList.add('-show');
      try{ window.renderer?.domElement?.requestPointerLock?.() }catch{}
    }

    // VarsayÄ±lan: her yerde AÃ‡IK
    openChat();

    // Butonlar
    closeB.addEventListener('click', closeChat);
    toggle.addEventListener('click', openChat);

    // KÄ±sayollar: ESC kapat, Enter / '/' aÃ§ (yazmÄ±yorken), Y toggle
    document.addEventListener('keydown', (e) => {
      const tag = (document.activeElement?.tagName || '').toLowerCase();
      const typing = tag === 'input' || tag === 'textarea';
      if(e.key === 'Escape'){ closeChat(); e.preventDefault(); }
      else if(!typing && (e.key === 'Enter' || e.key === '/')){ openChat(); e.preventDefault(); }
      else if(e.key.toLowerCase() === 'y'){ panel.classList.contains('-hidden') ? openChat() : closeChat(); e.preventDefault(); }
    });

    // Mobilde saÄŸ lookpad alanÄ±na Ã§arpmadan YANINA sÄ±ÄŸdÄ±r
    function fitNextToLookpad(){
      const lp = document.getElementById('lookpad');
      if(!lp) return;

      // lookpad saÄŸ-altta geniÅŸ bir alan (40vw). Chatâ€™i onun SOLUNA sÄ±ÄŸdÄ±r.
      const r = lp.getBoundingClientRect();
      const available = Math.max(220, Math.floor(r.left) - 24);   // saÄŸ alanÄ±n soluna kadar boÅŸluk
      const targetW   = Math.min(360, available, Math.floor(window.innerWidth * 0.9));
      panel.style.width = targetW + 'px';

      // SaÄŸ-alta sabit; alt Ã§entiÄŸe gÃ¶re gÃ¼venli boÅŸluk:
      panel.style.right  = 'clamp(8px,2vw,16px)';
      panel.style.bottom = `calc(12px + env(safe-area-inset-bottom))`;
    }

    // Yeniden hesapla
    ['resize','orientationchange'].forEach(evt => window.addEventListener(evt, fitNextToLookpad));
    setTimeout(fitNextToLookpad, 50);
  })();
  </script>



</body>
</html>
